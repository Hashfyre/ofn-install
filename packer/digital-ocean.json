{
  "description": "Builds DigitalOcean OFN Server image",
  "variables": {
    "do_api_token": "{{env `DO_API_TOKEN`}}",
    "do_source_image": "{{env `DO_SOURCE_IMAGE`}}",
    "do_region": "{{env `DO_REGION`}}",
    "do_ram_size": "{{env `DO_RAM_SIZE`}}",
    "ofn_region_host": "{{env `OFN_REGION_HOST`}}",
    "vault_pass": "{{env `VAULT_PASS`}}"
  },

  "builders": [{
      "type": "digitalocean",
      "api_token": "{{user `do_api_token`}}",
      "image": "{{user `do_source_image`}}",
      "region": "{{user `do_region`}}",
      "size": "{{user `do_ram_size`}}"
  }],

  "provisioners" : [
  {
    "type": "shell",
    "inline": [
      "sleep 5",
      "sudo apt-get update",
      "sudo apt-get -y install libffi-dev libssl-dev",
      "sudo apt-get -y install python-dev python-pip software-properties-common",
      "sudo pip install --upgrade setuptools",
      "sudo pip install ansible==2.2.1"
    ]
  },
  {
    "type": "shell-local",
    "command": "./bin/setup",
    "execute_command": [
      "/bin/bash", "-c", "{{.Command}}"
    ]
  },
  {
    "type": "shell",
    "inline": [
      "sleep 5",
      "VAULT_PASS={{user `vault_pass`}}",
      "echo $VAULT_PASS > .vaultpass"
    ]
  },
  {
    "type": "ansible-local",
    "playbook_dir": ".",
    "playbook_file": "./site.yml",
    "inventory_file": "./inventory/hosts",
    "group_vars": "./inventory/group_vars",
    "host_vars": "./inventory/host_vars",
    "extra_arguments": "--vault-password-file=.vaultpass"
  },
  {
    "type": "shell",
    "inline": [
      "sleep 10",
      "sudo pip uninstall ansible==2.2.1"
    ]
  }]
}
