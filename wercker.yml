box: hashfyre/containers:trusty-ansible-lint
no-response-timeout: 30
command-timeout: 30
test:
    steps:
      - script:
        name: Setup dependencies
        code: bin/setup
      - script:
        name: Run syntax checker
        code: |
          playbooks=`cat ./tests/playbook_list`
          echo ${playbooks}
          for file in ${playbooks}; do
            ansible-playbook -i inventory/dev --syntax-check ${file}
          done
      - script:
        name: Run ansible-lint
        code: |
          ansible-lint site.yml --exclude=community
bake-ofn:
    box: hashfyre/containers:packer
    steps:
      - script:
          name: Create Packer Log
          code: |
            PACKER_LOG=ofn_`date +%Y%m%d-%H%M%S`.log
            echo $PACKER_LOG
      - script:
          name: Bake OFN image
          code: |
            packer -machine-readable build packer/digital-ocean.json | tee ${PACKER_LOG}
            BUILD_FAILURE=`grep "Builds finished but no artifacts were created\|Error waiting for SSH:" ${PACKER_LOG} | wc -l`
            if [ ${BUILD_FAILURE} != 0 ]; then exit $?; fi
